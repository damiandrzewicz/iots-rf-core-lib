<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IoTs RF Core Library | Vuepress Docs Boilerplate</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/iots-rf-core-lib/assets/css/0.styles.775665ab.css" as="style"><link rel="preload" href="/iots-rf-core-lib/assets/js/app.3da6c32d.js" as="script"><link rel="preload" href="/iots-rf-core-lib/assets/js/2.9d39682d.js" as="script"><link rel="preload" href="/iots-rf-core-lib/assets/js/3.69302c94.js" as="script"><link rel="prefetch" href="/iots-rf-core-lib/assets/js/4.44c5df0d.js"><link rel="prefetch" href="/iots-rf-core-lib/assets/js/5.9f5653dd.js"><link rel="prefetch" href="/iots-rf-core-lib/assets/js/6.0f1178b2.js"><link rel="prefetch" href="/iots-rf-core-lib/assets/js/7.b0cc627a.js">
    <link rel="stylesheet" href="/iots-rf-core-lib/assets/css/0.styles.775665ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/iots-rf-core-lib/" aria-current="page" class="home-link router-link-exact-active router-link-active"><!----> <span class="site-name">Vuepress Docs Boilerplate</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/iots-rf-core-lib/" aria-current="page" class="active sidebar-link">IoTs RF Core Library</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#requirements" class="sidebar-link">Requirements</a></li><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#hardware" class="sidebar-link">Hardware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#circuit" class="sidebar-link">Circuit</a></li><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#bootloader" class="sidebar-link">Bootloader</a></li></ul></li><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#configuration" class="sidebar-link">Configuration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#eeprom-configuration" class="sidebar-link">EEPROM Configuration</a></li></ul></li><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#node-modes" class="sidebar-link">Node Modes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#state-mode" class="sidebar-link">State Mode</a></li></ul></li><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#radio-message-exchange" class="sidebar-link">Radio Message Exchange</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#base-message" class="sidebar-link">Base Message</a></li><li class="sidebar-sub-header"><a href="/iots-rf-core-lib/#node-gateway-pairing" class="sidebar-link">Node-Gateway Pairing</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="iots-rf-core-library"><a href="#iots-rf-core-library" class="header-anchor">#</a> IoTs RF Core Library</h1> <h2 id="requirements"><a href="#requirements" class="header-anchor">#</a> Requirements</h2> <ul><li>low power consumption (battery powered devices):
<ul><li>voltage range is from 2.4V to 3.3V,</li> <li>BOD below 1.8V,</li> <li>deep sleep modes:
<ul><li>for some amount of time,</li> <li>forever until interrupt,</li></ul></li></ul></li> <li>possibility of connecting various peripheral devices,</li> <li>send data to <code>gateway</code>,</li> <li>receive data from <code>gateway</code>,</li> <li>measure battery percent</li></ul> <h2 id="hardware"><a href="#hardware" class="header-anchor">#</a> Hardware</h2> <h3 id="circuit"><a href="#circuit" class="header-anchor">#</a> Circuit</h3> <p>Hadrware configuration is based on <code>Moteino R6</code> board referenced <a href="https://lowpowerlab.com/shop/product/99" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It is <code>Atmega328p</code> onboard. Board integrates <code>RFM69</code> radio modules. There are two variations of these modules: <code>5V/16MHz</code> and <code>3.3V/8MHz</code>. Unfortunately internal <code>8MHz</code> oscillator is inaccurate and sometimes serial communication issues occurs, especially with bootloader data exchange.</p> <p><img src="/iots-rf-core-lib/assets/img/MoteinoR6_front.f3dadcc4.jpg" alt="moteino R6"> <img src="/iots-rf-core-lib/assets/img/MoteinoR6_Schematic.2bfcd140.png" alt="moteino R6"></p> <p>Solution for above issues is to remove voltage regulator pointed in circle 1 and replace external 16MHz oscillator to <code>7,3628MHz</code> UART friendly frequency. For <code>8MHz</code> frequency with baud rate <code>57600</code> which is default value of <code>Optiboot</code> bootloader, error is about 3.7%. When baud is switched to <code>38400</code> situation is better but still not perfect. Error is about 0.2% and it depends on temperature of AVR controller. When external 7,3628MHz is used then frequency is really stable and UART error is 0%. That is the best situation.</p> <p><img src="/iots-rf-core-lib/assets/img/avr_uart_freq.77dbe9b8.png" alt="moteino R6"></p> <p>For IoTs RF Core external oscillator is replaced to <code>7,3628MHz</code> and voltage regulator is removed and missing connections are jumped. Before this modification (with 8MHz internal oscillator) programming by FTDI adapter wasn't possible on 4 from 20 boards. Communication wasn't reliable. After misidifactions communication is 100% reliable and all boards were flashed sucessfully.</p> <h3 id="bootloader"><a href="#bootloader" class="header-anchor">#</a> Bootloader</h3> <p>As Bootloader default <code>Arduino</code> <a href="https://github.com/Optiboot/optiboot" target="_blank" rel="noopener noreferrer">optiboot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is used. Binary needs to be build referring to previous frequency changes by following command:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make AVR_FREQ=7372800L BAUD_RATE=115200 atmega328
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>In the end following <code>platformio</code> configuration is used for flash fuses and bootloader:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[env:bootloader]
platform = atmelavr
board = moteino8mhz
framework = arduino
upload_protocol = usbasp
;Ext. Crystal Osc.; Frequency 3.0-8.0 MHz; Start-up time PWRDWN/RESET: 1K CK /14 CK + 4.1 ms; [CKSEL=1100 SUT=11] 
board_fuses.lfuse = 0xFC
board_fuses.hfuse = 0xDC
board_fuses.efuse = 0xFE
board_bootloader.lfuse = 0xFC
board_bootloader.hfuse = 0xDC
board_bootloader.efuse = 0xFE
;Bootloader file HEX
board_bootloader.file = bootloaders/optiboot_7370000hz_115200b_atmega328.hex
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h2> <p>Configuration is an interface class of following pure virtual operations:</p> <img src="https://www.plantuml.com/plantuml/svg/VSz12eGm30NGVK-HfOEN49mvI6nJATHMaYY8wDajk1kBsxp_FwGJHTPbYYOa9VPe2VgSV1XXDm3jZeCeezK3pllUVCmVh3au45ofK4MOqDN5Ha9-xWqvHmZocsRTwaKXVTSlULoYIWaSfgFaoeSN" alt="uml diagram"> <h3 id="eeprom-configuration"><a href="#eeprom-configuration" class="header-anchor">#</a> EEPROM Configuration</h3> <p>Every node can save its data to <code>EEPROM</code> memory. It is necessary due to keep data when power is down and for &quot;cacheing&quot; objects. &quot;Cacheing&quot; means when data are saved in unvolatile 'EEPROM' memory it's not necessary to ask Gateway for data. They can be read from &quot;memory&quot;. Base abstract class is <code>EEPROMConfig</code> which is a template class.</p> <img src="https://www.plantuml.com/plantuml/svg/TP312i8m44Jl-OezIOlu1OeKf4THjFUo9bi9fAdinXuizTjjMf4AUXlU3CpiPXAGmxrsIZiKWJm_dWxxNUChUzqKM-WKm78E4-i3e35C8caqExn8ODIXX-TNC5NHRXjhGB2b98Mc9MPhwCEPqFpYsX7ot8XE0Gk30PEnLUo3oW0Hd0SvbQsA4PHHpcQMQzKhDG3Y2ZN1jA_h_vniwvkZcdoGTr9bvCtmeXS0" alt="uml diagram"> <p>Template has 3 methods for saving, reading and clearing data directly in <code>EEPROM</code> memory. It contains three additional ethods for checking if structure of type <code>T</code> is empty, setting it empty and setting defaults. Constructor argument is starting memory address of initialized structure.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Remember to do not allocate another config class with address which conflicts previously allocated <code>EEPROM</code> memory. For example if first class is allocated at address 0 and has size 12 bytes and second config is allocated at address 8, then it will due to undefined behaviour. That's a reason why method <code>dataSize</code> is introduced.</p></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Structure cannot has <code>virtual</code> methods, because this kind of objects cannot be restored from <code>EEPROM</code> memory.</p></div> <h4 id="radioconfig-eeprom-implementation"><a href="#radioconfig-eeprom-implementation" class="header-anchor">#</a> RadioConfig EEPROM implementation</h4> <img src="https://www.plantuml.com/plantuml/svg/VP11IyD048Nl-HLpL4iFdYoXb89DeQWelHQHCJjDbsvsqjtPX4NxtzsG7b8KRyFx7ZDltj8BEWcroKg3taDHl6rVNnxPxdKrtwBIFCmh55na5zD8_ye0FfaDQ5_KZSIRM-2MdDEA4cbPA_0a_w0LxJ4OyMDw_kDG7w0_1Z2n91sxuqRb4BILsOSCUeL27SPVUXcySBrsT0faovYezRgofC2mhGPF0YusyaHnT__mdaDvG3UGXZjopzIIoU6oDUKRzmJpx-bqdFMQtbt3_f5iILQbqdy0" alt="uml diagram"> <h4 id="uuidconfig-eeprom-implementation"><a href="#uuidconfig-eeprom-implementation" class="header-anchor">#</a> UUIDConfig EEPROM implementation</h4> <img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLd1r3GZoztNEpqlBJBS93VLqWJ1T4aiIxRYWQX32rLmA2adv-JaAcSMkkGKbbHgQ2lbbgKL5cIcfG9co_CmKXUBK4ZnIBgbfYQKv9SN8ihMOze2i1zcbNLgQcH9jQ1PhfP1KMG9MYknW1PiQNLqaRQYIMYXo82Ev75BpKe1-1m00" alt="uml diagram"> <h2 id="node-modes"><a href="#node-modes" class="header-anchor">#</a> Node Modes</h2> <h3 id="state-mode"><a href="#state-mode" class="header-anchor">#</a> State Mode</h3> <img src="https://www.plantuml.com/plantuml/svg/VLFBJiCm4BplL_W8I1MSKH8L4AMLa40jz48HSkDDPUIkaRr1xT-J1qcT1nn7Cplx67lgMJhEzmRUBjx5P9A8DJgT7UyiPNe78QZObK7ycbdtv5w9jRa_y89ON8jCQeDgGsU41wv4BtgF8XPNvqEJfLJQhf1KKUZpD4Nl0MvIrfRcafH1LybcCcNhZalqMBSumH5rPTfeNGl-KZvBxJJj6kql123BA0ncB6mckhN5i2mBTikq8OLRcrEAGg6HHu3nmvJj1YRrnfVroG1gqq-hwSEN9YAAIf0a0AT3jNC_Qiz8mU6wci2c2GN2ke6cFqr0_fTtF-P8uRTESIrDZabd9rcjVrggasexJgs28CHHgacjJuQT-ezuPCdXc-WNbFFVCeau5lF5mnnWMbou-2O_" alt="uml diagram"> <h2 id="radio-message-exchange"><a href="#radio-message-exchange" class="header-anchor">#</a> Radio Message Exchange</h2> <p>Messages:</p> <img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhDAyrLS4eiJWrAJCdCzqqjBavCJ-Mgvb9G24ZCBD81qa6fwPd59QbWjcDEPbagY15SabW2PZZdv-OcvgLmrN8vfEQb04q40000" alt="uml diagram"> <p>Directions:</p> <img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhDAyrLy4qjBavCJtN9B4fDBidCp-Egvb9G24ejB4qjBj41CuiBylEAKxbgkHnIyrA0-W00" alt="uml diagram"> <h3 id="base-message"><a href="#base-message" class="header-anchor">#</a> Base Message</h3> <p><code>&lt;type&gt;|&lt;direction&gt;|&lt;batteryPercent&gt;</code></p> <h3 id="node-gateway-pairing"><a href="#node-gateway-pairing" class="header-anchor">#</a> Node-Gateway Pairing</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuU9oICrB0J80" alt="uml diagram"></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/iots-rf-core-lib/assets/js/app.3da6c32d.js" defer></script><script src="/iots-rf-core-lib/assets/js/2.9d39682d.js" defer></script><script src="/iots-rf-core-lib/assets/js/3.69302c94.js" defer></script>
  </body>
</html>
