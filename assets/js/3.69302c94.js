(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{398:function(e,a,t){e.exports=t.p+"assets/img/MoteinoR6_front.f3dadcc4.jpg"},399:function(e,a,t){e.exports=t.p+"assets/img/MoteinoR6_Schematic.2bfcd140.png"},400:function(e,a,t){e.exports=t.p+"assets/img/avr_uart_freq.77dbe9b8.png"},408:function(e,a,t){"use strict";t.r(a);var s=t(56),r=Object(s.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"iots-rf-core-library"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#iots-rf-core-library"}},[e._v("#")]),e._v(" IoTs RF Core Library")]),e._v(" "),s("h2",{attrs:{id:"requirements"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#requirements"}},[e._v("#")]),e._v(" Requirements")]),e._v(" "),s("ul",[s("li",[e._v("low power consumption (battery powered devices):\n"),s("ul",[s("li",[e._v("voltage range is from 2.4V to 3.3V,")]),e._v(" "),s("li",[e._v("BOD below 1.8V,")]),e._v(" "),s("li",[e._v("deep sleep modes:\n"),s("ul",[s("li",[e._v("for some amount of time,")]),e._v(" "),s("li",[e._v("forever until interrupt,")])])])])]),e._v(" "),s("li",[e._v("possibility of connecting various peripheral devices,")]),e._v(" "),s("li",[e._v("send data to "),s("code",[e._v("gateway")]),e._v(",")]),e._v(" "),s("li",[e._v("receive data from "),s("code",[e._v("gateway")]),e._v(",")]),e._v(" "),s("li",[e._v("measure battery percent")])]),e._v(" "),s("h2",{attrs:{id:"hardware"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hardware"}},[e._v("#")]),e._v(" Hardware")]),e._v(" "),s("h3",{attrs:{id:"circuit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#circuit"}},[e._v("#")]),e._v(" Circuit")]),e._v(" "),s("p",[e._v("Hadrware configuration is based on "),s("code",[e._v("Moteino R6")]),e._v(" board referenced "),s("a",{attrs:{href:"https://lowpowerlab.com/shop/product/99",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),s("OutboundLink")],1),e._v(". It is "),s("code",[e._v("Atmega328p")]),e._v(" onboard. Board integrates "),s("code",[e._v("RFM69")]),e._v(" radio modules. There are two variations of these modules: "),s("code",[e._v("5V/16MHz")]),e._v(" and "),s("code",[e._v("3.3V/8MHz")]),e._v(". Unfortunately internal "),s("code",[e._v("8MHz")]),e._v(" oscillator is inaccurate and sometimes serial communication issues occurs, especially with bootloader data exchange.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(398),alt:"moteino R6"}}),e._v(" "),s("img",{attrs:{src:t(399),alt:"moteino R6"}})]),e._v(" "),s("p",[e._v("Solution for above issues is to remove voltage regulator pointed in circle 1 and replace external 16MHz oscillator to "),s("code",[e._v("7,3628MHz")]),e._v(" UART friendly frequency. For "),s("code",[e._v("8MHz")]),e._v(" frequency with baud rate "),s("code",[e._v("57600")]),e._v(" which is default value of "),s("code",[e._v("Optiboot")]),e._v(" bootloader, error is about 3.7%. When baud is switched to "),s("code",[e._v("38400")]),e._v(" situation is better but still not perfect. Error is about 0.2% and it depends on temperature of AVR controller. When external 7,3628MHz is used then frequency is really stable and UART error is 0%. That is the best situation.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(400),alt:"moteino R6"}})]),e._v(" "),s("p",[e._v("For IoTs RF Core external oscillator is replaced to "),s("code",[e._v("7,3628MHz")]),e._v(" and voltage regulator is removed and missing connections are jumped. Before this modification (with 8MHz internal oscillator) programming by FTDI adapter wasn't possible on 4 from 20 boards. Communication wasn't reliable. After misidifactions communication is 100% reliable and all boards were flashed sucessfully.")]),e._v(" "),s("h3",{attrs:{id:"bootloader"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bootloader"}},[e._v("#")]),e._v(" Bootloader")]),e._v(" "),s("p",[e._v("As Bootloader default "),s("code",[e._v("Arduino")]),e._v(" "),s("a",{attrs:{href:"https://github.com/Optiboot/optiboot",target:"_blank",rel:"noopener noreferrer"}},[e._v("optiboot"),s("OutboundLink")],1),e._v(" is used. Binary needs to be build referring to previous frequency changes by following command:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("make AVR_FREQ=7372800L BAUD_RATE=115200 atmega328\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("In the end following "),s("code",[e._v("platformio")]),e._v(" configuration is used for flash fuses and bootloader:")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[env:bootloader]\nplatform = atmelavr\nboard = moteino8mhz\nframework = arduino\nupload_protocol = usbasp\n;Ext. Crystal Osc.; Frequency 3.0-8.0 MHz; Start-up time PWRDWN/RESET: 1K CK /14 CK + 4.1 ms; [CKSEL=1100 SUT=11] \nboard_fuses.lfuse = 0xFC\nboard_fuses.hfuse = 0xDC\nboard_fuses.efuse = 0xFE\nboard_bootloader.lfuse = 0xFC\nboard_bootloader.hfuse = 0xDC\nboard_bootloader.efuse = 0xFE\n;Bootloader file HEX\nboard_bootloader.file = bootloaders/optiboot_7370000hz_115200b_atmega328.hex\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br")])]),s("h2",{attrs:{id:"configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[e._v("#")]),e._v(" Configuration")]),e._v(" "),s("p",[e._v("Configuration is an interface class of following pure virtual operations:")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/VSz12eGm30NGVK-HfOEN49mvI6nJATHMaYY8wDajk1kBsxp_FwGJHTPbYYOa9VPe2VgSV1XXDm3jZeCeezK3pllUVCmVh3au45ofK4MOqDN5Ha9-xWqvHmZocsRTwaKXVTSlULoYIWaSfgFaoeSN",alt:"uml diagram"}}),e._v(" "),s("h3",{attrs:{id:"eeprom-configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#eeprom-configuration"}},[e._v("#")]),e._v(" EEPROM Configuration")]),e._v(" "),s("p",[e._v("Every node can save its data to "),s("code",[e._v("EEPROM")]),e._v(' memory. It is necessary due to keep data when power is down and for "cacheing" objects. "Cacheing" means when data are saved in unvolatile \'EEPROM\' memory it\'s not necessary to ask Gateway for data. They can be read from "memory". Base abstract class is '),s("code",[e._v("EEPROMConfig")]),e._v(" which is a template class.")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/TP312i8m44Jl-OezIOlu1OeKf4THjFUo9bi9fAdinXuizTjjMf4AUXlU3CpiPXAGmxrsIZiKWJm_dWxxNUChUzqKM-WKm78E4-i3e35C8caqExn8ODIXX-TNC5NHRXjhGB2b98Mc9MPhwCEPqFpYsX7ot8XE0Gk30PEnLUo3oW0Hd0SvbQsA4PHHpcQMQzKhDG3Y2ZN1jA_h_vniwvkZcdoGTr9bvCtmeXS0",alt:"uml diagram"}}),e._v(" "),s("p",[e._v("Template has 3 methods for saving, reading and clearing data directly in "),s("code",[e._v("EEPROM")]),e._v(" memory. It contains three additional ethods for checking if structure of type "),s("code",[e._v("T")]),e._v(" is empty, setting it empty and setting defaults. Constructor argument is starting memory address of initialized structure.")]),e._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),s("p",[e._v("Remember to do not allocate another config class with address which conflicts previously allocated "),s("code",[e._v("EEPROM")]),e._v(" memory. For example if first class is allocated at address 0 and has size 12 bytes and second config is allocated at address 8, then it will due to undefined behaviour. That's a reason why method "),s("code",[e._v("dataSize")]),e._v(" is introduced.")])]),e._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),s("p",[e._v("Structure cannot has "),s("code",[e._v("virtual")]),e._v(" methods, because this kind of objects cannot be restored from "),s("code",[e._v("EEPROM")]),e._v(" memory.")])]),e._v(" "),s("h4",{attrs:{id:"radioconfig-eeprom-implementation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#radioconfig-eeprom-implementation"}},[e._v("#")]),e._v(" RadioConfig EEPROM implementation")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/VP11IyD048Nl-HLpL4iFdYoXb89DeQWelHQHCJjDbsvsqjtPX4NxtzsG7b8KRyFx7ZDltj8BEWcroKg3taDHl6rVNnxPxdKrtwBIFCmh55na5zD8_ye0FfaDQ5_KZSIRM-2MdDEA4cbPA_0a_w0LxJ4OyMDw_kDG7w0_1Z2n91sxuqRb4BILsOSCUeL27SPVUXcySBrsT0faovYezRgofC2mhGPF0YusyaHnT__mdaDvG3UGXZjopzIIoU6oDUKRzmJpx-bqdFMQtbt3_f5iILQbqdy0",alt:"uml diagram"}}),e._v(" "),s("h4",{attrs:{id:"uuidconfig-eeprom-implementation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#uuidconfig-eeprom-implementation"}},[e._v("#")]),e._v(" UUIDConfig EEPROM implementation")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLd1r3GZoztNEpqlBJBS93VLqWJ1T4aiIxRYWQX32rLmA2adv-JaAcSMkkGKbbHgQ2lbbgKL5cIcfG9co_CmKXUBK4ZnIBgbfYQKv9SN8ihMOze2i1zcbNLgQcH9jQ1PhfP1KMG9MYknW1PiQNLqaRQYIMYXo82Ev75BpKe1-1m00",alt:"uml diagram"}}),e._v(" "),s("h2",{attrs:{id:"node-modes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node-modes"}},[e._v("#")]),e._v(" Node Modes")]),e._v(" "),s("h3",{attrs:{id:"state-mode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#state-mode"}},[e._v("#")]),e._v(" State Mode")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/VLFBJiCm4BplL_W8I1MSKH8L4AMLa40jz48HSkDDPUIkaRr1xT-J1qcT1nn7Cplx67lgMJhEzmRUBjx5P9A8DJgT7UyiPNe78QZObK7ycbdtv5w9jRa_y89ON8jCQeDgGsU41wv4BtgF8XPNvqEJfLJQhf1KKUZpD4Nl0MvIrfRcafH1LybcCcNhZalqMBSumH5rPTfeNGl-KZvBxJJj6kql123BA0ncB6mckhN5i2mBTikq8OLRcrEAGg6HHu3nmvJj1YRrnfVroG1gqq-hwSEN9YAAIf0a0AT3jNC_Qiz8mU6wci2c2GN2ke6cFqr0_fTtF-P8uRTESIrDZabd9rcjVrggasexJgs28CHHgacjJuQT-ezuPCdXc-WNbFFVCeau5lF5mnnWMbou-2O_",alt:"uml diagram"}}),e._v(" "),s("h2",{attrs:{id:"radio-message-exchange"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#radio-message-exchange"}},[e._v("#")]),e._v(" Radio Message Exchange")]),e._v(" "),s("p",[e._v("Messages:")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhDAyrLS4eiJWrAJCdCzqqjBavCJ-Mgvb9G24ZCBD81qa6fwPd59QbWjcDEPbagY15SabW2PZZdv-OcvgLmrN8vfEQb04q40000",alt:"uml diagram"}}),e._v(" "),s("p",[e._v("Directions:")]),e._v(" "),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhDAyrLy4qjBavCJtN9B4fDBidCp-Egvb9G24ejB4qjBj41CuiBylEAKxbgkHnIyrA0-W00",alt:"uml diagram"}}),e._v(" "),s("h3",{attrs:{id:"base-message"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#base-message"}},[e._v("#")]),e._v(" Base Message")]),e._v(" "),s("p",[s("code",[e._v("<type>|<direction>|<batteryPercent>")])]),e._v(" "),s("h3",{attrs:{id:"node-gateway-pairing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node-gateway-pairing"}},[e._v("#")]),e._v(" Node-Gateway Pairing")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("test\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuU9oICrB0J80",alt:"uml diagram"}})])}),[],!1,null,null,null);a.default=r.exports}}]);